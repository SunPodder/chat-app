import{Q as A,i as I,h as k,e as F,f as O,j as s,r as h,u as U,U as Q,s as v,G as L,a as _,g as Y,b as q}from"./index-BhQeG5K_.js";import{I as z,C as P,b as D,a as V}from"./input-DDaKLcAe.js";import{A as B,a as H,b as G}from"./avatar-CEbp2X4h.js";import{T as K,a as W,b as Z,c as J}from"./tooltip-DJFuUmzR.js";import{c as R}from"./createLucideIcon-8aQ_-RDO.js";import"./index-utpKsIgz.js";import"./index-BZpRwNlR.js";import"./index-BqoLo0Hk.js";var X=class extends A{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:I()})}getOptimisticResult(e){return e.behavior=I(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var x,p;const{state:n}=e,i=super.createResult(e,t),{isFetching:l,isRefetching:u,isError:f,isRefetchError:o}=i,a=(p=(x=n.fetchMeta)==null?void 0:x.fetchMore)==null?void 0:p.direction,d=f&&a==="forward",m=l&&a==="forward",g=f&&a==="backward",r=l&&a==="backward";return{...i,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:F(t,n.data),hasPreviousPage:k(t,n.data),isFetchNextPageError:d,isFetchingNextPage:m,isFetchPreviousPageError:g,isFetchingPreviousPage:r,isRefetchError:o&&!d&&!g,isRefetching:u&&!m&&!r}}};function ee(e,t){return O(e,X)}/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=R("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=R("MessageCircleMore",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}],["path",{d:"M8 12h.01",key:"czm47f"}],["path",{d:"M12 12h.01",key:"1mp3jc"}],["path",{d:"M16 12h.01",key:"1l6xoz"}]]);/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=R("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function re(e){const n=new Date().getTime()-e.getTime(),i=Math.floor(n/(1e3*60));if(i<=5)return s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Active Now"]});if(i<=1440){const l=Math.floor(i/60);return i<60?`Active ${i} mins ago`:`Active ${l} hours ago`}else return e.toLocaleDateString()}function ae({chat:e}){var t;return s.jsxs("div",{className:"flex gap-2 border-b py-4 px-6",children:[s.jsxs(B,{className:"w-10 h-10",children:[s.jsx(H,{src:(t=e.to.avatar)==null?void 0:t.url,alt:e.to.name.first}),s.jsx(G,{children:e.to.name.first[0]})]}),s.jsxs("div",{className:"flex flex-col justify-center",children:[s.jsxs("div",{className:"text-lg font-medium",children:[e.to.name.first," ",e.to.name.last]}),s.jsx("div",{className:"text-slate-500 text-sm",children:re(new Date(e.to.last_online))})]})]})}var M=new Map,b=new WeakMap,$=0,ne=void 0;function ie(e){return e?(b.has(e)||($+=1,b.set(e,$.toString())),b.get(e)):"0"}function oe(e){return Object.keys(e).sort().filter(t=>e[t]!==void 0).map(t=>`${t}_${t==="root"?ie(e.root):e[t]}`).toString()}function ce(e){const t=oe(e);let n=M.get(t);if(!n){const i=new Map;let l;const u=new IntersectionObserver(f=>{f.forEach(o=>{var a;const d=o.isIntersecting&&l.some(m=>o.intersectionRatio>=m);e.trackVisibility&&typeof o.isVisible>"u"&&(o.isVisible=d),(a=i.get(o.target))==null||a.forEach(m=>{m(d,o)})})},e);l=u.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),n={id:t,observer:u,elements:i},M.set(t,n)}return n}function le(e,t,n={},i=ne){if(typeof window.IntersectionObserver>"u"&&i!==void 0){const a=e.getBoundingClientRect();return t(i,{isIntersecting:i,target:e,intersectionRatio:typeof n.threshold=="number"?n.threshold:0,time:0,boundingClientRect:a,intersectionRect:a,rootBounds:a}),()=>{}}const{id:l,observer:u,elements:f}=ce(n),o=f.get(e)||[];return f.has(e)||f.set(e,o),o.push(t),u.observe(e),function(){o.splice(o.indexOf(t),1),o.length===0&&(f.delete(e),u.unobserve(e)),f.size===0&&(u.disconnect(),M.delete(l))}}function ue({threshold:e,delay:t,trackVisibility:n,rootMargin:i,root:l,triggerOnce:u,skip:f,initialInView:o,fallbackInView:a,onChange:d}={}){var m;const[g,r]=h.useState(null),c=h.useRef(d),[x,p]=h.useState({inView:!!o,entry:void 0});c.current=d,h.useEffect(()=>{if(f||!g)return;let j;return j=le(g,(T,N)=>{p({inView:T,entry:N}),c.current&&c.current(T,N),N.isIntersecting&&u&&j&&(j(),j=void 0)},{root:l,rootMargin:i,threshold:e,trackVisibility:n,delay:t},a),()=>{j&&j()}},[Array.isArray(e)?e.toString():e,g,l,i,u,f,n,a,t]);const w=(m=x.entry)==null?void 0:m.target,C=h.useRef(void 0);!g&&w&&!u&&!f&&C.current!==w&&(C.current=w,p({inView:!!o,entry:void 0}));const y=[r,x.inView,x.entry];return y.ref=y[0],y.inView=y[1],y.entry=y[2],y}const fe=e=>{const t=new Date(e),n=new Date,i=t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear(),l=t.getDate()===n.getDate()-1&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear();return i?t.toLocaleTimeString():l?"Yesterday":t.toLocaleDateString()};function E(){return s.jsx("div",{className:"w-full flex flex-col px-8 h-[calc(70vh)] overflow-y-scroll pb-4",children:[...Array(5)].map((e,t)=>s.jsx("div",{className:`flex ${t%2===0?"justify-start":"justify-end"} mt-3`,children:s.jsx("div",{className:`
              ${t%2===0?"bg-secondary":"bg-primary"}
              py-2 px-3 rounded-md
              animate-pulse
              w-[${Math.floor(Math.random()*30+20)}%]
              min-w-[100px]
              h-[36px]
            `,style:{animationDelay:`${t*.1}s`,width:`${Math.floor(Math.random()*30+20)}%`}})},t))})}function de({chatId:e}){const t=U(Q),[n,i]=h.useState(!1),{ref:l,inView:u}=ue(),{data:f,fetchNextPage:o,hasNextPage:a,isFetchingNextPage:d,status:m}=ee({queryKey:["messages",e],queryFn:async({pageParam:r=0})=>{if(!e)return{messages:[],nextCursor:void 0};const c=await L(`/messages/${e}?offset=${r}&limit=20`);return{messages:c,nextCursor:c.length===20?r+20:void 0}},getNextPageParam:r=>r.nextCursor,initialPageParam:0});if(h.useEffect(()=>{u&&a&&!d&&o(),v.on("typing",(r,c)=>{r===r&&i(c)})},[u,a,d,o]),m==="pending")return s.jsx(E,{});if(m==="error")return s.jsx("div",{className:"h-full flex items-center justify-center text-destructive text-xl",children:"Error loading messages"});const g=f.pages.flatMap(r=>r.messages).filter((r,c,x)=>c===x.findIndex(p=>p.id===r.id&&p.from===r.from));return g!=null&&g.length?s.jsxs("div",{className:"flex flex-col-reverse w-full",children:[n&&s.jsx("div",{className:"flex justify-start mt-3",children:s.jsx("div",{className:"flex items-center gap-2",children:s.jsxs("div",{className:"bg-secondary flex justify-center py-2 px-3 rounded-r-md animate-pulse w-[30%] min-w-[100px] h-[36px]",children:["Typing",s.jsxs("div",{className:"flex justify-center items-end gap-1",children:[s.jsx("span",{className:"w-1 h-1 bg-primary/70 rounded-full animate-bounce",style:{animationDelay:"0s"}}),s.jsx("span",{className:"w-1 h-1 bg-primary/70 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),s.jsx("span",{className:"w-1 h-1 bg-primary/70 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]})]})})}),g.map((r,c)=>{const x=g[c+1];return s.jsx("div",{className:`flex ${(x==null?void 0:x.from)===r.from?"mt-[1px]":"mt-3"} ${r.from===(t==null?void 0:t.id)?"justify-end":"justify-start"}`,children:s.jsx(K,{delayDuration:100,children:s.jsxs(W,{children:[s.jsx(Z,{asChild:!0,children:s.jsxs("div",{className:`${r.from===(t==null?void 0:t.id)?"bg-primary text-white rounded-l-md":"bg-secondary rounded-r-md"} py-2 px-3 cursor-pointer flex flex-col gap-2`,children:[r.text,r.media&&r.media.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2",children:r.media.map(p=>s.jsx("img",{src:`${p.url}`,alt:"Message attachment",className:"max-w-[200px] rounded-md",loading:"lazy"},p.id))})]})}),s.jsx(J,{side:"right",children:fe(r.created_at)})]})})},r.id||c)}),d&&s.jsx(E,{}),s.jsx("div",{ref:l,className:"h-4"})]}):s.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground text-xl",children:"Start a conversation"})}function me({chatId:e}){return s.jsx("div",{className:"w-full flex flex-col-reverse px-8 h-[calc(100vh-200px)] md:h-[calc(100vh-240px)] overflow-y-scroll pb-4",ref:t=>t&&(t.scrollTop=t.scrollHeight),children:s.jsx(de,{chatId:e})})}function ge({chat:e,chatId:t}){const n=h.useRef(null),[i,l]=h.useState(""),[u,f]=h.useState([]),[o,a]=h.useState([]);console.log(u),h.useEffect(()=>()=>{n.current&&clearTimeout(n.current),o.forEach(r=>{URL.revokeObjectURL(r)})},[o]);const d=r=>{l(r),!(!v.connected||!t)&&(n.current&&clearTimeout(n.current),r.length>0?(v.emit("typing",{chatId:t,isTyping:!0}),n.current=setTimeout(()=>{v.emit("typing",{chatId:t,isTyping:!1})},3e3)):v.emit("typing",{chatId:t,isTyping:!1}))};function m(r){if(r.target.files){const c=Array.from(r.target.files);f(c);const x=c.map(p=>URL.createObjectURL(p));a(x)}}async function g(r){var c;r.preventDefault(),i&&(c=v)!=null&&c.connected&&(v.emit("send_message",{to:t,message:i},e.last_message===null),l(""))}return s.jsxs("div",{className:"w-full p-4 min-h-[60px] relative",children:[o.length>0&&s.jsx("div",{className:"absolute bottom-[75%] left-0 right-0 flex gap-2 mx-12 mb-4 bg-white/95 backdrop-blur-sm rounded-t-lg p-2 border border-b-0 shadow-lg",children:o.map((r,c)=>s.jsx("img",{src:r,alt:`Preview ${c}`,className:"w-16 h-16 object-cover rounded-md",onLoad:()=>{URL.revokeObjectURL(r)},onError:()=>{URL.revokeObjectURL(r)}},c))}),s.jsxs("form",{className:"flex justify-center items-center w-full gap-2",onSubmit:g,children:[s.jsxs("label",{children:[s.jsx(te,{className:"w-8 h-8"}),s.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:m}),s.jsx("span",{className:"sr-only",children:"Upload an image"})]}),s.jsx(z,{value:i,type:"text",placeholder:"Type a message",className:"flex-grow flex-1",onChange:r=>d(r.target.value)}),s.jsx("button",{type:"submit",children:s.jsx(se,{className:"w-8 h-8"})})]})]})}function Ne({className:e}){const t=_(),{chatId:n}=Y(),[i,l]=h.useState(n),{data:u,isLoading:f}=q({queryKey:["chat",i],queryFn:async()=>i?await L(`/conversations/${i}`):null});return h.useEffect(()=>{n&&l(n)},[n]),h.useEffect(()=>{v.on("connect",()=>{console.log("connected")}),v.on("disconnect",()=>{console.log("disconnected")}),v.on("sent_message",o=>{t.setQueryData(["messages",i],a=>{var d,m;return a!=null&&a.pages?{...a,pages:[{messages:[o,...((d=a.pages[0])==null?void 0:d.messages)||[]],nextCursor:(m=a.pages[0])==null?void 0:m.nextCursor},...a.pages.slice(1)]}:a})}),v.on("recieve_message",o=>{t.setQueryData(["messages",i],a=>{var d,m;return a!=null&&a.pages?{...a,pages:[{messages:[o,...((d=a.pages[0])==null?void 0:d.messages)||[]],nextCursor:(m=a.pages[0])==null?void 0:m.nextCursor},...a.pages.slice(1)]}:a})})},[t,i]),f?s.jsx(P,{className:`flex justify-center items-center ${e}`,children:s.jsxs(D,{className:"text-2xl text-center opacity-40 flex items-center gap-1",children:[s.jsx(S,{className:"w-12 h-12"}),"Loading conversation..."]})}):i?s.jsxs(P,{className:`flex flex-col ${e}`,children:[s.jsx(V,{className:"p-0",children:s.jsx(ae,{chat:u})}),s.jsx(me,{chatId:i}),s.jsx(ge,{chat:u,chatId:i})]}):s.jsx(P,{className:`h-100vh flex justify-center items-center ${e}`,children:s.jsxs(D,{className:"text-2xl text-center opacity-40 flex items-center gap-1",children:[s.jsx(S,{className:"w-12 h-12"}),"Select a conversation to start chatting"]})})}export{Ne as default};
